<script>
/**
 * HOLIDAY INN ROOM LOG â€” CLOUD SYNC (GOOGLE APPS SCRIPT) + LOCAL BACKUP
 *
 * Works with your EXISTING page:
 * - Anything marked data-save="1" is persisted
 * - Supports input + textarea + checkbox
 * - Keeps localStorage as backup
 * - Adds automatic cross-computer sync via your Apps Script Web App
 */

// ====== SET THESE 2 VALUES ======
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwEZQkE1u_63xdPR-0tVLKvZKopF5EuLJyH9aY_71HeWxfcqexP6tYjJm1HQmVXs7Xf/exec";
const STATE_KEY  = "holiday_inn_inspection_state_v1"; // MUST match what your sheet stores

// local backup cache key
const CACHE_KEY = "holiday_inn_roomlog_localcache_v1";

// debounce so we don't spam server
let saveTimer = null;
let isSaving = false;

// ---------- LOCAL SAVE/LOAD ----------
function buildPayloadFromPage(){
  const data = {};
  document.querySelectorAll('input[data-save="1"], textarea[data-save="1"]').forEach(el => {
    if(!el.id) return;
    if(el.type === "checkbox"){
      data[el.id] = el.checked;
    }else{
      data[el.id] = el.value || "";
    }
  });
  return data;
}

function applyPayloadToPage(data){
  if(!data || typeof data !== "object") return;

  Object.keys(data).forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;

    if(el.type === "checkbox"){
      el.checked = !!data[id];
    }else{
      el.value = data[id];
      if(el.tagName === "TEXTAREA"){
        autoResize(el);
      }
    }
  });
}

function saveLocal(payload){
  try{
    localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
  }catch(e){
    console.warn("Local save failed", e);
  }
}

function loadLocal(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    console.warn("Local load failed", e);
    return null;
  }
}

// ---------- CLOUD GET/POST ----------
async function cloudGet(){
  const url = `${WEBAPP_URL}?key=${encodeURIComponent(STATE_KEY)}`;
  const res = await fetch(url, { method:"GET", cache:"no-store" });
  const out = await res.json();
  if(!out || !out.ok) throw new Error((out && out.error) || "Cloud GET failed");
  return out.json || {};
}

async function cloudPost(payload){
  // No custom headers (avoids preflight/CORS headaches)
  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ key: STATE_KEY, json: payload })
  });
  const out = await res.json();
  if(!out || !out.ok) throw new Error((out && out.error) || "Cloud POST failed");
  return out;
}

// ---------- RESIZE ----------
function autoResize(el){
  el.style.height = "auto";
  el.style.height = el.scrollHeight + "px";
}

// ---------- SAVE PIPELINE ----------
function scheduleCloudSave(ms=600){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    saveCloudNow().catch(err => console.warn("Cloud save failed:", err));
  }, ms);
}

async function saveCloudNow(){
  if(isSaving) return;
  isSaving = true;

  const payload = buildPayloadFromPage();

  // always local backup first
  saveLocal(payload);

  try{
    await cloudPost(payload);
  } finally {
    isSaving = false;
  }
}

// ---------- BOOT ----------
async function boot(){
  // 1) Load local first so page "looks alive" instantly
  const local = loadLocal();
  if(local) applyPayloadToPage(local);

  // 2) Then load cloud and apply (cloud wins)
  try{
    const cloud = await cloudGet();
    if(cloud && typeof cloud === "object" && Object.keys(cloud).length){
      applyPayloadToPage(cloud);
      saveLocal(cloud); // keep local in sync
    }
  }catch(e){
    console.warn("Cloud load failed (permissions/offline?)", e);
  }

  // 3) Wire up autosave for ANY data-save field
  document.addEventListener("change", (e) => {
    const t = e.target;
    if(!t) return;
    if(t.matches('input[data-save="1"], textarea[data-save="1"]')){
      if(t.tagName === "TEXTAREA") autoResize(t);
      saveLocal(buildPayloadFromPage());
      scheduleCloudSave(700);
    }
  });

  document.addEventListener("input", (e) => {
    const t = e.target;
    if(!t) return;
    if(t.matches('textarea[data-save="1"]')){
      autoResize(t);
      saveLocal(buildPayloadFromPage());
      scheduleCloudSave(800);
    }
    if(t.matches('input[data-save="1"]') && t.type !== "checkbox"){
      saveLocal(buildPayloadFromPage());
      scheduleCloudSave(900);
    }
  });

  // 4) If you have a "Clear Floor" button, it will still work with your own logic.
  // (This script doesn't overwrite any of your existing functions.)
}

document.addEventListener("DOMContentLoaded", boot);
</script>

