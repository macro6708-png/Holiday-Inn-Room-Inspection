<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Holiday Inn ‚Äî Room Inspection</title>

<!-- iPad / iOS friendly meta -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Holiday Inn">

<style>
  :root{
    --bg:#f7f8fb;
    --card:#ffffff;
    --text:#1f2937;
    --muted:#6b7280;
    --shadow:0 10px 25px rgba(15,23,42,.18);
    --radius:22px;

    /* pastels */
    --p1:#bfe3ff;  /* blue */
    --p2:#ffd6e7;  /* pink */
    --p3:#d8ffd6;  /* green */
    --p4:#fff2bf;  /* yellow */
    --p5:#e6d6ff;  /* purple */
    --ring:#9acbff;

    --hubNotesBg:#f6f1ff;
    --hubNotesBorder:#e6ddff;

    --ok:#16a34a;
    --warn:#f59e0b;
    --bad:#dc2626;
  }

  *{box-sizing:border-box;}

  body{
    margin:0;
    padding:18px;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:linear-gradient(135deg,#f5f7ff,#e5f6ff);
    color:var(--text);
  }

  .wrapper{ max-width:1040px; margin:0 auto; }

  h1{
    text-align:center;
    margin:6px 0 2px;
    font-size:1.8rem;
    letter-spacing:.04em;
  }

  .subtitle{
    text-align:center;
    font-size:.9rem;
    color:var(--muted);
    margin-bottom:10px;
  }

  .topbar{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:12px;
  }

  .date-row{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:8px;
    font-size:.9rem;
  }
  .date-row label{ font-weight:600; }
  .date-row input[type="date"]{
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.7);
    font-size:.9rem;
    background:#f9fafb;
  }
  .date-row input[type="date"]:focus{
    outline:none;
    border-color:var(--ring);
    box-shadow:0 0 0 2px rgba(154,203,255,.55);
    background:#fff;
  }

  .card{
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px 16px 20px;
    border:1px solid rgba(148,163,184,.35);
    overflow:hidden;
  }

  .card-header-band{
    background:linear-gradient(90deg,#e5edff,#fdf2ff);
    margin:-16px -16px 16px;
    padding:10px 16px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .card-header-text{
    font-size:.82rem;
    color:var(--muted);
    line-height:1.35;
    flex:1 1 320px;
  }

  .header-actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
    flex:0 0 auto;
  }

  .btn-pill{
    border:none;
    border-radius:999px;
    padding:7px 15px;
    font-size:.8rem;
    font-weight:600;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
    white-space:nowrap;
    box-shadow:0 6px 14px rgba(59,130,246,.35);
    transition:transform .08s ease, box-shadow .08s ease, opacity .08s ease;
    user-select:none;
  }
  .btn-pill:active{ transform:translateY(1px); box-shadow:none; opacity:.9; }
  .btn-pill span.icon{font-size:.9rem;}

  .btn-print{ background:#2563eb; color:#fff; }
  .btn-clear{
    background:#fee2e2;
    color:#991b1b;
    box-shadow:0 6px 14px rgba(248,113,113,.35);
  }

  .sync-pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:7px 12px;
    border-radius:999px;
    background:rgba(255,255,255,.75);
    border:1px solid rgba(148,163,184,.45);
    font-size:.78rem;
    color:#111827;
  }
  .dot{
    width:10px; height:10px; border-radius:999px; display:inline-block;
    background:var(--warn);
    box-shadow:0 0 0 2px rgba(0,0,0,.04);
  }
  .dot.ok{ background:var(--ok); }
  .dot.bad{ background:var(--bad); }
  .dot.warn{ background:var(--warn); }

  .tabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:12px;
    justify-content:center;
  }

  .tab-btn{
    flex:1 1 90px;
    border:none;
    border-radius:999px;
    padding:8px 14px;
    font-size:.9rem;
    cursor:pointer;
    background:#e5ecff;
    color:#1f2937;
    max-width:160px;
    transition:transform .1s ease, box-shadow .1s ease, background .1s ease, color .1s ease;
  }
  .tab-btn[data-floor="2"]{ background:rgba(191,227,255,.9); }
  .tab-btn[data-floor="3"]{ background:rgba(255,214,231,.95); }
  .tab-btn[data-floor="4"]{ background:rgba(216,255,214,.95); }
  .tab-btn[data-floor="5"]{ background:rgba(255,242,191,.95); }

  .tab-btn.active{
    background:#2563eb;
    color:#fff;
    box-shadow:0 6px 14px rgba(37,99,235,.45);
    transform:translateY(-1px);
    font-weight:600;
  }
  .tab-btn:active{ transform:translateY(0); box-shadow:none; }

  .floor-blurb{ margin-bottom:6px; }
  .floor-title{ font-size:1.05rem; font-weight:600; margin-bottom:4px; }

  .badge-row{
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-size:.72rem;
    padding:2px 9px;
    border-radius:999px;
    margin-left:6px;
  }
  .badge-2{ background:var(--p1); }
  .badge-3{ background:var(--p2); }
  .badge-4{ background:var(--p3); }
  .badge-5{ background:var(--p4); }

  .helper-text{ font-size:.8rem; color:var(--muted); }

  .table-wrap{
    max-height:72vh;
    overflow:auto;
    border-radius:16px;
    border:1px solid rgba(148,163,184,.35);
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:.9rem;
    background:#fff;
  }

  thead{
    position:sticky;
    top:0;
    background:#eef2ff;
    z-index:1;
  }

  th,td{
    padding:7px 6px;
    text-align:left;
    vertical-align:top;
  }

  th{
    font-size:.78rem;
    text-transform:uppercase;
    letter-spacing:.04em;
    color:#4b5563;
    border-bottom:1px solid #c7d2fe;
    background:#eef2ff;
  }

  tbody tr:nth-child(even) td{ background:#f9fafb; }
  tbody tr:nth-child(odd) td{ background:#ffffff; }
  tbody tr:hover td{ background:#f1f5ff; }

  .room-col{ width:70px; font-weight:700; white-space:nowrap; }
  .check-col{ width:90px; text-align:center; }
  .notes-col{ width:auto; }

  .notes-input{
    width:100%;
    min-width:160px;
    padding:6px 8px;
    border-radius:12px;
    border:1px solid var(--hubNotesBorder);
    font-size:.85rem;
    background:var(--hubNotesBg);
    resize:none;
    overflow:hidden;
    line-height:1.3;
  }
  .notes-input:focus{
    outline:none;
    border-color:var(--ring);
    box-shadow:0 0 0 2px rgba(154,203,255,.55);
    background:#fff;
  }

  .check-wrap{
    display:flex;
    justify-content:center;
    align-items:center;
    padding-top:2px;
  }

  .check-wrap input[type="checkbox"]{
    width:17px;
    height:17px;
    accent-color:#2563eb;
    cursor:pointer;
  }

  @media (max-width:700px){
    body{ padding:10px; }
    .card{ padding:12px 12px 16px; }
    th,td{ padding:6px 4px; font-size:.8rem; }
    .notes-input{ font-size:.8rem; }
  }

  /* Print mode */
  @media print{
    body{ background:#fff; padding:0; margin:0; }
    .subtitle,.tabs,.card-header-band,.btn-pill,.sync-pill{ display:none !important; }
    .wrapper{ max-width:none; margin:0; }
    .card{ box-shadow:none; border:none; padding:0; margin:0; }
    .table-wrap{ max-height:none; overflow:visible; border-radius:0; border:none; }
    h1{ font-size:1.4rem; margin:0 0 4px 0; text-align:left; }
    .topbar{ justify-content:flex-start; margin:0 0 6px 0; }
    table{ font-size:.85rem; }
    th,td{ padding:6px 4px; }
    tbody tr:nth-child(even) td, tbody tr:nth-child(odd) td{ background:#fff; }
    .notes-input{ background:#fff; border:1px solid #d1d5db; min-height:40px; }
  }
</style>
</head>

<body>
<div class="wrapper">
  <h1>The Holiday Inn ‚Äî Room Inspection</h1>
  <div class="subtitle">
    Select a floor, mark <strong>Passed / Failed / Not Inspected</strong>, and record any violations or notes.
  </div>

  <div class="topbar">
    <div class="date-row">
      <label for="inspectionDate">Inspection Date:</label>
      <input type="date" id="inspectionDate" name="inspectionDate">
    </div>

    <div class="sync-pill" title="Cloud sync status">
      <span class="dot warn" id="syncDot"></span>
      <span id="syncText">Sync: idle</span>
    </div>
  </div>

  <div class="card">
    <div class="card-header-band">
      <div class="card-header-text">
        This log saves locally <strong>and</strong> auto-syncs to your Google Sheet for multi-computer use.
        If the network is down, it still works and will sync once you edit again.
      </div>
      <div class="header-actions">
        <button class="btn-pill btn-print" type="button" id="btnPrintFloor">
          <span class="icon">üñ®Ô∏è</span><span>Create PDF</span>
        </button>
        <button class="btn-pill btn-clear" type="button" id="btnClearFloor">
          <span class="icon">üßπ</span><span>Clear Floor</span>
        </button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-floor="2">2nd Floor (200s)</button>
      <button class="tab-btn" data-floor="3">3rd Floor (300s)</button>
      <button class="tab-btn" data-floor="4">4th Floor (400s)</button>
      <button class="tab-btn" data-floor="5">5th Floor (500s)</button>
    </div>

    <div class="floor-blurb" id="floorBlurb">
      <div class="floor-title" id="floorTitle"></div>
      <div class="helper-text" id="floorHelper"></div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="room-col">ROOM #</th>
            <th class="check-col">PASSED</th>
            <th class="check-col">FAILED</th>
            <th class="check-col">NOT<br>INSPECTED</th>
            <th class="notes-col">NOTES / VIOLATIONS</th>
          </tr>
        </thead>
        <tbody id="floorBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ===========================
   CLOUD SYNC SETTINGS
   =========================== */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwEZQkE1u_63xdPR-0tVLKvZKopF5EuLJyH9aY_71HeWxfcqexP6tYjJm1HQmVXs7Xf/exec";
const STATE_KEY  = "holiday_inn_inspection_state_v1";

const CACHE_KEY  = "holiday_inn_roomlog_localcache_v1";

/* ===========================
   STATE MODEL (what we save)
   {
     version: 1,
     inspectionDate: "YYYY-MM-DD",
     floors: {
       "2": { "201": { status:"passed|failed|not|", notes:"" }, ... },
       "3": ...
     },
     updatedAt: "iso"
   }
   =========================== */
let state = {
  version: 1,
  inspectionDate: "",
  floors: {},
  updatedAt: ""
};

let activeFloor = "2";

/* ===========================
   FLOOR CONFIG
   =========================== */
function range(start, end){
  const out = [];
  for(let i=start;i<=end;i++) out.push(i);
  return out;
}

const floorConfigs = {
  "2": {
    label: "2nd Floor ‚Äî 200 Rooms",
    badgeClass: "badge-2",
    badgeText: "Rooms 201‚Äì212, 214‚Äì226, 230‚Äì233",
    helper: "Select one status per room and add notes for any violations or comments.",
    rooms: [...range(201,212), ...range(214,226), ...range(230,233)]
  },
  "3": {
    label: "3rd Floor ‚Äî 300 Rooms",
    badgeClass: "badge-3",
    badgeText: "Rooms 301‚Äì312, 314‚Äì327, 329‚Äì331",
    helper: "300 wing rooms.",
    rooms: [...range(301,312), ...range(314,327), ...range(329,331)]
  },
  "4": {
    label: "4th Floor ‚Äî 400 Rooms",
    badgeClass: "badge-4",
    badgeText: "Rooms 401‚Äì412, 414‚Äì427, 429‚Äì431",
    helper: "400 wing rooms.",
    rooms: [...range(401,412), ...range(414,427), ...range(429,431)]
  },
  "5": {
    label: "5th Floor ‚Äî 500 Rooms",
    badgeClass: "badge-5",
    badgeText: "Rooms 501‚Äì512, 514‚Äì527, 529‚Äì531",
    helper: "500 wing rooms.",
    rooms: [...range(501,512), ...range(514,527), ...range(529,531)]
  }
};

function ensureRoom(floor, room){
  floor = String(floor);
  room  = String(room);
  state.floors[floor] = state.floors[floor] || {};
  state.floors[floor][room] = state.floors[floor][room] || { status:"", notes:"" };
  return state.floors[floor][room];
}

/* ===========================
   UI HELPERS
   =========================== */
function autoResize(el){
  el.style.height = "auto";
  el.style.height = el.scrollHeight + "px";
}

function setSyncStatus(kind, text){
  const dot = document.getElementById("syncDot");
  const label = document.getElementById("syncText");
  dot.classList.remove("ok","warn","bad");
  dot.classList.add(kind);
  label.textContent = text;
}

/* ===========================
   LOCAL SAVE/LOAD
   =========================== */
function saveLocal(){
  try{
    localStorage.setItem(CACHE_KEY, JSON.stringify(state));
  }catch(e){
    console.warn("Local save failed", e);
  }
}

function loadLocal(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || typeof obj !== "object") return null;
    return obj;
  }catch(e){
    console.warn("Local load failed", e);
    return null;
  }
}

/* ===========================
   CLOUD GET/POST
   =========================== */
async function cloudGet(){
  const url = `${WEBAPP_URL}?key=${encodeURIComponent(STATE_KEY)}`;
  const res = await fetch(url, { method:"GET", cache:"no-store" });
  const out = await res.json();
  if(!out || !out.ok) throw new Error((out && out.error) || "Cloud GET failed");
  return out.json || {};
}

async function cloudPost(payload){
  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({ key: STATE_KEY, json: payload })
  });
  const out = await res.json();
  if(!out || !out.ok) throw new Error((out && out.error) || "Cloud POST failed");
  return out;
}

/* ===========================
   AUTO-SYNC PIPELINE
   =========================== */
let saveTimer = null;
let isSaving = false;

function scheduleCloudSave(ms=650){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    saveCloudNow().catch(err => {
      console.warn("Cloud save failed:", err);
      setSyncStatus("bad", "Sync: error (saved locally)");
    });
  }, ms);
}

async function saveCloudNow(){
  if(isSaving) return;
  isSaving = true;

  // stamp
  state.updatedAt = new Date().toISOString();

  // always save local first
  saveLocal();

  setSyncStatus("warn", "Sync: saving...");
  try{
    await cloudPost(state);
    setSyncStatus("ok", "Sync: saved");
  } finally {
    isSaving = false;
  }
}

/* ===========================
   RENDER TABLE
   =========================== */
function renderFloorBlurb(floor){
  const cfg = floorConfigs[floor];
  const title = document.getElementById("floorTitle");
  const helper = document.getElementById("floorHelper");
  if(!cfg){ title.textContent = ""; helper.textContent = ""; return; }

  title.innerHTML = `
    ${cfg.label}
    <span class="badge-row ${cfg.badgeClass}">${cfg.badgeText}</span>
  `;
  helper.textContent = cfg.helper || "";
}

function setExclusiveStatus(floor, room, status){
  const rec = ensureRoom(floor, room);
  rec.status = status;
}

function buildTableForFloor(floor){
  activeFloor = String(floor);
  renderFloorBlurb(activeFloor);

  const cfg = floorConfigs[activeFloor];
  const tbody = document.getElementById("floorBody");
  tbody.innerHTML = "";

  (cfg.rooms || []).forEach(roomNum => {
    const room = String(roomNum);
    const rec = ensureRoom(activeFloor, room);

    const tr = document.createElement("tr");

    // Room #
    const tdRoom = document.createElement("td");
    tdRoom.className = "room-col";
    tdRoom.textContent = room;
    tr.appendChild(tdRoom);

    // Passed / Failed / Not (checkboxes but exclusive)
    const statuses = [
      { key:"passed", label:"PASSED" },
      { key:"failed", label:"FAILED" },
      { key:"not",    label:"NOT" }
    ];

    statuses.forEach(s => {
      const td = document.createElement("td");
      td.className = "check-col";

      const wrap = document.createElement("div");
      wrap.className = "check-wrap";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = (rec.status === s.key);

      cb.addEventListener("change", () => {
        // exclusive: if checked => set that status; if unchecked => clear
        if(cb.checked){
          setExclusiveStatus(activeFloor, room, s.key);
        }else{
          setExclusiveStatus(activeFloor, room, "");
        }
        // re-render row only (cheap enough: rebuild floor)
        buildTableForFloor(activeFloor);
        scheduleCloudSave(650);
      });

      wrap.appendChild(cb);
      td.appendChild(wrap);
      tr.appendChild(td);
    });

    // Notes
    const tdNotes = document.createElement("td");
    tdNotes.className = "notes-col";

    const ta = document.createElement("textarea");
    ta.className = "notes-input";
    ta.rows = 1;
    ta.placeholder = "Notes / violations‚Ä¶";
    ta.value = rec.notes || "";

    ta.addEventListener("input", () => {
      rec.notes = ta.value;
      autoResize(ta);
      scheduleCloudSave(750);
    });

    // resize after insert
    setTimeout(() => autoResize(ta), 0);

    tdNotes.appendChild(ta);
    tr.appendChild(tdNotes);

    tbody.appendChild(tr);
  });
}

/* ===========================
   CLEAR FLOOR
   =========================== */
function clearCurrentFloor(){
  const floor = String(activeFloor);
  const cfg = floorConfigs[floor];
  if(!cfg) return;

  cfg.rooms.forEach(roomNum => {
    const room = String(roomNum);
    const rec = ensureRoom(floor, room);
    rec.status = "";
    rec.notes = "";
  });

  buildTableForFloor(floor);
  scheduleCloudSave(650);
}

/* ===========================
   BOOT
   =========================== */
async function boot(){
  setSyncStatus("warn", "Sync: loading...");

  // Load local first (instant)
  const local = loadLocal();
  if(local && typeof local === "object"){
    state = local;
  }

  // Fill date from local
  const dateEl = document.getElementById("inspectionDate");
  if(dateEl) dateEl.value = state.inspectionDate || "";

  // Render default floor
  buildTableForFloor(activeFloor);

  // Then load cloud (cloud wins if it has data)
  try{
    const cloud = await cloudGet();
    if(cloud && typeof cloud === "object" && (cloud.floors || cloud.inspectionDate || cloud.updatedAt)){
      state = cloud;

      if(dateEl) dateEl.value = state.inspectionDate || "";
      buildTableForFloor(activeFloor);

      saveLocal();
      setSyncStatus("ok", "Sync: loaded");
    }else{
      setSyncStatus("ok", "Sync: ready");
    }
  }catch(e){
    console.warn("Cloud load failed", e);
    setSyncStatus("bad", "Sync: offline (local only)");
  }

  // Date changes
  if(dateEl){
    dateEl.addEventListener("change", () => {
      state.inspectionDate = dateEl.value || "";
      scheduleCloudSave(650);
    });
  }

  // Tabs
  const tabButtons = document.querySelectorAll(".tab-btn");
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      buildTableForFloor(btn.getAttribute("data-floor"));
    });
  });

  // Buttons
  const printBtn = document.getElementById("btnPrintFloor");
  const clearBtn = document.getElementById("btnClearFloor");

  if(printBtn) printBtn.addEventListener("click", () => window.print());

  if(clearBtn){
    clearBtn.addEventListener("click", () => {
      if(confirm("Clear all statuses and notes for this floor?")){
        clearCurrentFloor();
      }
    });
  }
}

document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
